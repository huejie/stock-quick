# 2026-02-24 每日记录

## 🛠️ 技术问题修复

### GitLab Webhook服务修复（2026-02-24）

**问题1：GitLab Token权限不足**
- **错误**: `403 - {"error":"insufficient_scope","error_description":"The request requires higher privileges than provided by the access token.","scope":"ai_workflows api read_api"}`
- **原因**: 旧Token缺少 `api` 权限
- **解决**: 更新为新Token `glpat-hO7Kq5QZ-F_5pHpbWsNG9W86MQp1OjJuMgk.01.0z0zuoear`
- **验证**: MR 5评论成功（`Comment posted to MR 5 successfully`）

**问题2：飞书通知失败**
- **错误**: `Error: Feishu account "default" not configured`
- **原因**: OpenClaw配置了多个飞书账户（xiaok、yinyue），但webhook脚本未指定使用哪个账户
- **解决**: 在 `openclaw message send` 命令中添加 `--account xiaok` 参数
- **修改文件**: `/root/.openclaw/workspace/gitlab-webhook-server.py`

**修复后的工作流程（最终版本）：**
1. GitLab发送webhook → MR事件（action=open）
2. 获取MR diff（最多6000字符）
3. **使用内置规则进行代码审查**（不依赖Claude Code）
4. 发送飞书通知（使用xiaok账户）
5. 自动回复到GitLab MR评论区

**服务状态：**
- 服务名：gitlab-webhook
- 端口：8888
- 路径：/webhook/gitlab
- 状态：active (running)

**代码审查系统升级：**
- ❌ 移除Claude Code依赖（解决returncode: 1问题）
- ✅ 实现企业级代码审查规则
- ✅ 分类：阻断级问题（安全性/功能性/性能）+ 优化级问题（代码风格/可维护性）
- ✅ 支持Vue/React/TypeScript/CSS等多种技术栈
- ✅ 友好专业的评论风格

## 📊 定时任务执行情况

### ✅ 成功执行的任务
1. **财经新闻早报** (00:00 UTC) - A股开市前瞻
2. **早间财经大事总结** (00:03 UTC) - 央行万亿逆回购、金价突破5145美元
3. **持仓更新提醒** (08:30 UTC) - 提醒用户更新持仓
4. **持仓投资建议** (08:31 UTC) - 基于成本价的投资建议

### 📈 当前持仓情况（2026-02-24）
- **总持仓成本**: ¥39,663.00
- **持仓数量**: 3只股票
  - 中文在线 (300794): 400股 @ ¥38.96
  - 网宿科技 (300017): 900股 @ ¥15.73
  - 蓝色光标 (300058): 500股 @ ¥19.84

**投资建议**:
- 设置止损点（-8%至-10%）
- 关注公司业绩和行业发展
- 分散风险，避免仓位过重

### ⚠️ 遇到的问题
- **webhook脚本多次测试** - 用户触发多次webhook测试
- **OpenClaw status命令卡死** - 需要手动kill进程

## 🎯 用户需求记录

### GitLab Webhook配置
用户要求修复GitLab webhook的代码审查功能：
1. MR自动触发代码审查
2. 飞书通知审查结果
3. GitLab MR评论区自动回复

**解决方案：**
- 更新GitLab Token（添加api权限）
- 修复飞书账户配置问题
- 服务重启并验证

## 💡 重要洞察

### 多账户配置问题
OpenClaw支持多个飞书账户配置，但调用时必须明确指定 `--account` 参数：
```bash
openclaw message send --channel feishu --account xiaok --target user:xxx --message "xxx"
```

### Claude Code集成挑战
- Claude Code在webhook服务中调用失败
- 可能原因：环境变量、权限、timeout设置
- 临时方案：禁用AI审查，只保留通知功能

## 📝 代码审查系统升级（2026-02-24 晚间）

### 从Claude Code到内置规则
**用户反馈**: "代码审查不要用Claude Code了，你自己审查可以吗"
**解决方案**: 完全重构代码审查逻辑

**第一阶段：简单规则**
- 检查TODO/FIXME、console.log、import*等
- 识别测试代码、文档注释
- 评论较简单，用户反馈"太简单了"

**第二阶段：前端规范增强**
- Vue相关：组件name、Props验证、v-if vs v-show、:key属性
- TypeScript：any类型检查、接口定义
- React：Hooks规则、Props解构、key属性
- CSS：!important、内联样式、className检查
- JavaScript：var vs let/const、== vs ===、可选链

**第三阶段：企业级专业审查（最终版本）**
按照用户提供的专业提示词重新设计：

**1. 评论风格：友好且专业**
- 先肯定优点（如有）
- 再指出问题（阻断级 > 优化级）
- 给出具体可落地的改进方案

**2. 审查优先级分类**
- 🔴 **阻断级问题**（必须修复）：
  - 功能性：空指针、Promise未处理、资源未释放
  - 安全性：SQL注入、XSS、敏感信息硬编码
  - 性能：N+1查询、大文件上传、嵌套循环
  
- 💡 **优化级问题**（建议改进）：
  - 代码风格：var vs let/const、== vs ===
  - 可读性：Props解构、文档注释
  - 可维护性：TODO标记、硬编码、import顺序

**3. 问题描述格式化**
每个问题包含：位置、类型、风险、建议

**4. 语言适配**
- Vue/React最佳实践
- TypeScript类型检查
- JavaScript现代特性
- CSS/样式规范

**5. 避免无效评论**
- 不纠结空格换行
- 不质疑业务逻辑
- 聚焦技术实现质量

### 审查规则总结
**安全性检查**：SQL注入、XSS、敏感信息泄露
**性能检查**：N+1查询、文件上传限制、循环嵌套
**功能性检查**：空指针、Promise处理、资源释放
**代码质量检查**：var/let/const、==/===、console.log
**框架规范检查**：Vue、React、TypeScript、CSS
**代码风格检查**：TODO、硬编码、import顺序

## 🔧 代码审查系统问题修复（2026-02-24 深夜）

### 用户反馈的问题
1. **评论内容不准确**
   - 错误匹配：把`var a = 1`识别为console.log问题
   - 错误匹配：把HTML链接识别为代码变更较大

2. **缺少文件和行号定位**
   - 用户要求：指定代码在哪个文件的哪一行
   - 原问题：只有模糊的位置描述，没有精确到文件和行号

### 解决方案：完全重构代码定位逻辑

**新增 `extract_line_info()` 函数**：
- 解析GitLab diff格式
- 提取文件名（`+++ b/path/to/file`）
- 解析行号（`@@ -start,count +start,count @@`）
- 精确匹配问题代码行
- 返回结构：`{file: str, line: int, code: str}`

**精确匹配逻辑**：
```python
# 只在真正包含问题的代码行报告
if issue['type'] == '代码质量' and 'console.log' in issue['issue']:
    if 'console.log' in code_line:  # 精确匹配
        is_problem = True
```

**新的显示格式**：
```markdown
### 1. 代码质量：包含console.log调试语句
**位置**: `src/main.js` 第42行
**代码**: `console.log('debug:', data)`
- **风险**: 生产环境不应包含调试日志
- **修改建议**: 移除或使用条件编译
```

**移除的误报规则**：
- ❌ "代码变更较大"检查（误报太多）
- ❌ 不精确的关键词匹配
- ✅ 只报告真实存在问题的代码

### 技术要点

**GitLab diff格式解析**：
- 文件头：`+++ b/src/main.js`
- 行号：`@@ -10,5 +10,7 @@` 表示从第10行开始
- 新增行：以`+`开头
- 删除行：以`-`开头

**精确匹配策略**：
- 按问题类型分别匹配
- 检查完整的代码行内容
- 避免部分匹配导致的误报

### 最终决策：恢复使用Claude Code（2026-02-24 17:17）

**用户要求**：内置规则的代码审查不准确，还是用Claude Code吧

**问题回顾**：
1. ❌ 内置规则错误匹配：`var a = 1`被识别为console.log问题
2. ❌ 没有准确定位文件和行号
3. ❌ 用户反馈："还是有相同的问题"

**解决方案**：
- ✅ 移除所有内置规则代码（500+行）
- ✅ 恢复使用Claude Code进行AI代码审查
- ✅ 使用用户提供的专业提示词（企业级代码审查专家）
- ✅ 改进错误处理，失败时给出明确提示

**专业提示词要点**：
1. 评论风格：友好且专业，先肯定优点，再指出问题，给出具体建议
2. 审查优先级：功能性/安全性/性能 > 代码风格/可读性/可维护性
3. 问题描述：明确位置（文件+行号）、类型、风险、建议
4. 语言适配：根据代码语言使用最佳实践
5. 避免无效评论：不纠结格式，不质疑业务逻辑，聚焦技术实现

**代码审查函数结构**：
```python
async def code_review(diff, mr_title, user, project):
    # 构造专业提示词
    review_prompt = f"""你是一位资深的企业级代码审查专家...
    **MR信息**：项目、用户、标题
    **代码diff**：...
    """
    
    # 调用Claude Code
    review_result = run_claude_code_review(review_prompt)
    
    # 处理结果
    if review_result and not timeout:
        return 审查结果
    else:
        return 错误提示
```

**经验教训**：
1. 内置规则难以做到准确和全面
2. AI审查更智能，能理解上下文
3. 用户的专业提示词是关键
4. 错误处理很重要，即使失败也要给出明确反馈

---
*最后更新: 2026-02-24 17:20 UTC+8*
