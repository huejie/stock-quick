# 飞书文档格式修复指南

## 问题原因

根据飞书文档API的限制，以下Markdown语法会导致格式错乱：

1. **❌ 不支持Markdown表格** → 需要转换为列表
2. **❌ 每段内容不能超过200字符** → 需要分段写入
3. **❌ 特殊字符未转义** → 导致解析错误（`#`, `&`, `<`, `>`, `*`, `_`）
4. **❌ 复杂嵌套列表** → 只支持2级缩进
5. **❌ HTML标签** → 不支持
6. **❌ 引用块（`>`）** → 不支持
7. **❌ 水平线（`---`）** → 不支持

## 解决方案

### 方法1：使用格式修复工具（推荐）

我已经创建了自动修复工具 `/root/.openclaw/scripts/fix-feishu-markdown.js`

**使用方法：**

```bash
# 修复单个文件
node /root/.openclaw/scripts/fix-feishu-markdown.js input.md output.md

# 只处理表格问题（不分段）
node /root/.openclaw/scripts/fix-feishu-markdown.js input.md output.md --no-segment

# 自定义最大段落长度
node /root/.openclaw/scripts/fix-feishu-markdown.js input.md output.md --max-len=300
```

**工具功能：**
- ✅ 自动将表格转换为列表
- ✅ 自动分段长段落（默认200字符）
- ✅ 自动转义特殊字符
- ✅ 移除不支持的语法（HTML、引用块等）

### 方法2：手动修复规则

如果你手动编辑Markdown，遵循以下规则：

#### 1. 避免使用表格

**❌ 错误（表格）：**
```markdown
| 项目 | 状态 | 优先级 |
|------|------|--------|
| 任务A | 进行中 | 高 |
| 任务B | 已完成 | 中 |
```

**✅ 正确（列表）：**
```markdown
📋 项目 | 状态 | 优先级
  • 任务A | 进行中 | 高
  • 任务B | 已完成 | 中
```

#### 2. 控制段落长度

**❌ 错误（超长段落）：**
```markdown
这是一段很长的文字内容，包含了超过200个字符的限制，会导致飞书文档写入失败或者格式错乱，需要手动分割成多个短段落。
```

**✅ 正确（分段）：**
```markdown
这是一段很长的文字内容。

需要分割成多个短段落。

每段控制在200字符以内。
```

#### 3. 转义特殊字符

**❌ 错误（未转义）：**
```markdown
# 这是标题
**这是粗体**
*这是斜体*
```

**✅ 正确（已转义）：**
```markdown
\\# 这是标题
\\*\\*这是粗体\\*\\*
\\*这是斜体\\*
```

#### 4. 简化列表结构

**❌ 错误（复杂嵌套）：**
```markdown
1. 第一层
   1.1 第二层
      1.1.1 第三层（太深了）
```

**✅ 正确（简单嵌套）：**
```markdown
1. 第一层
   • 第二层
```

## 飞书文档写入最佳实践

### 1. 使用feishu_doc工具写入时

```bash
# 创建新文档
feishu_doc create --title "文档标题"

# 分段写入内容（每次<200字符）
feishu_doc append --token "文档token" --content "第一段内容"
feishu_doc append --token "文档token" --content "第二段内容"
```

### 2. 写入到知识库中

**重要：** 必须写入到知识库，否则文档会在机器人名下！

```bash
# 写入到指定知识库
feishu_wiki create --space-id "知识库ID" --title "标题"
```

### 3. 检查权限

确保机器人有以下权限：
- `docs:doc` - 创建文档
- `docs:doc:readonly` - 读取文档
- `docs:document.content:read` - 读取文档内容
- `docs:document.media:upload` - 上传媒体

## 常见问题排查

### 问题1：写入时提示"操作失败"

**可能原因：**
- 段落超过200字符
- 包含不支持的语法（表格、HTML等）

**解决方法：**
- 使用修复工具处理
- 或手动分段并简化格式

### 问题2：文档创建成功但格式错乱

**可能原因：**
- 包含Markdown表格
- 特殊字符未转义

**解决方法：**
- 将表格转换为列表
- 使用修复工具转义特殊字符

### 问题3：文档无法在知识库中找到

**可能原因：**
- 直接创建文档，未指定知识库
- 文档在机器人名下

**解决方法：**
- 使用feishu_wiki创建到知识库
- 或手动移动文档到知识库

## 示例：修复财经新闻总结

**原始内容（有表格和长段落）：**
```markdown
## 今日财经大事

| 时间 | 事件 | 影响 |
|------|------|------|
| 08:00 | 美联储宣布利率决议 | 市场波动加大 |
| 10:00 | 中国央行降准 | 利好A股 |

这是一段很长的新闻描述，包含了超过200个字符的限制，详细的解释了美联储决议的具体内容和市场反应，需要进行分段处理才能正常写入飞书文档。
```

**修复后（列表+分段）：**
```markdown
\\## 今日财经大事

📋 时间 | 事件 | 影响
  • 08:00 | 美联储宣布利率决议 | 市场波动加大
  • 10:00 | 中国央行降准 | 利好A股

这是一段很长的新闻描述。

详细的解释了美联储决议的具体内容。

需要进行分段处理才能正常写入飞书文档。
```

## 总结

1. **优先使用修复工具**：自动处理大部分格式问题
2. **遵守长度限制**：每段不超过200字符
3. **避免表格**：改用列表格式
4. **转义特殊字符**：使用修复工具或手动添加反斜杠
5. **写入知识库**：确保文档长期保存

---

*最后更新：2026-02-13*
