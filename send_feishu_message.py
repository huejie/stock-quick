#!/usr/bin/env python3
"""
é£ä¹¦æ¶ˆæ¯å‘é€è„šæœ¬
ç”¨äºå®šæ—¶ä»»åŠ¡å‘é€æ¶ˆæ¯åˆ°é£ä¹¦
"""

import os
import sys
import json
import requests
from datetime import datetime

def get_feishu_token():
    """è·å–é£ä¹¦è®¿é—®ä»¤ç‰Œ"""
    # ä»OpenClawé…ç½®ä¸­è·å–app_idå’Œapp_secret
    config_path = "/root/.openclaw/openclaw.json"
    try:
        with open(config_path, 'r') as f:
            config = json.load(f)
        
        app_id = config.get("channels", {}).get("feishu", {}).get("appId", "")
        app_secret = config.get("channels", {}).get("feishu", {}).get("appSecret", "")
        
        if not app_id or not app_secret:
            print("é”™è¯¯: æœªæ‰¾åˆ°é£ä¹¦é…ç½®")
            return None
        
        # è·å–è®¿é—®ä»¤ç‰Œ
        url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
        headers = {"Content-Type": "application/json; charset=utf-8"}
        data = {
            "app_id": app_id,
            "app_secret": app_secret
        }
        
        response = requests.post(url, headers=headers, json=data)
        if response.status_code == 200:
            result = response.json()
            if result.get("code") == 0:
                return result.get("tenant_access_token")
            else:
                print(f"è·å–tokenå¤±è´¥: {result}")
        else:
            print(f"HTTPé”™è¯¯: {response.status_code}")
            
    except Exception as e:
        print(f"è·å–tokenå¼‚å¸¸: {e}")
    
    return None

def send_feishu_message(message, chat_id=None):
    """å‘é€é£ä¹¦æ¶ˆæ¯"""
    token = get_feishu_token()
    if not token:
        print("æ— æ³•è·å–é£ä¹¦è®¿é—®ä»¤ç‰Œ")
        return False
    
    # å¦‚æœæ²¡æœ‰æŒ‡å®šchat_idï¼Œå°è¯•å‘é€åˆ°é»˜è®¤ä¼šè¯
    # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
    if not chat_id:
        # å°è¯•è·å–å½“å‰ä¼šè¯çš„chat_id
        # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦ä»OpenClawä¼šè¯ä¿¡æ¯ä¸­è·å–
        print("è­¦å‘Š: æœªæŒ‡å®šchat_idï¼Œä½¿ç”¨é»˜è®¤å¤„ç†")
        # è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥è·å–å½“å‰ä¼šè¯çš„chat_id
        return False
    
    url = "https://open.feishu.cn/open-apis/im/v1/messages"
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json; charset=utf-8"
    }
    
    data = {
        "receive_id": chat_id,
        "msg_type": "text",
        "content": json.dumps({"text": message})
    }
    
    try:
        response = requests.post(
            f"{url}?receive_id_type=chat_id",
            headers=headers,
            json=data
        )
        
        if response.status_code == 200:
            result = response.json()
            if result.get("code") == 0:
                print(f"æ¶ˆæ¯å‘é€æˆåŠŸ: {result.get('data', {}).get('message_id')}")
                return True
            else:
                print(f"æ¶ˆæ¯å‘é€å¤±è´¥: {result}")
        else:
            print(f"HTTPé”™è¯¯: {response.status_code}")
            
    except Exception as e:
        print(f"å‘é€æ¶ˆæ¯å¼‚å¸¸: {e}")
    
    return False

def send_simple_message():
    """å‘é€ç®€å•çš„æµ‹è¯•æ¶ˆæ¯"""
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    message = f"""ğŸ± æµ‹è¯•æ¶ˆæ¯ - å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ

æ—¶é—´: {current_time}
æ¥æº: Pythonè„šæœ¬æµ‹è¯•
çŠ¶æ€: å®šæ—¶ä»»åŠ¡ç³»ç»Ÿå·¥ä½œæ­£å¸¸

è¿™æ˜¯ä¸€æ¡é€šè¿‡Pythonè„šæœ¬å‘é€çš„æµ‹è¯•æ¶ˆæ¯ã€‚
å¦‚æœæ”¶åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜å®šæ—¶ä»»åŠ¡çš„æ¶ˆæ¯å‘é€æœºåˆ¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚"""
    
    print(f"å‡†å¤‡å‘é€æ¶ˆæ¯: {message[:50]}...")
    
    # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ­£ç¡®çš„chat_id
    # æš‚æ—¶åªæ‰“å°æ¶ˆæ¯ï¼Œä¸å®é™…å‘é€
    print("æ¶ˆæ¯å†…å®¹:")
    print(message)
    print("\næ³¨æ„: éœ€è¦é…ç½®æ­£ç¡®çš„chat_idæ‰èƒ½å®é™…å‘é€åˆ°é£ä¹¦")
    
    # åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨ send_feishu_message(message, chat_id)
    return True

if __name__ == "__main__":
    if len(sys.argv) > 1:
        # å¦‚æœæœ‰å‚æ•°ï¼Œä½¿ç”¨å‚æ•°ä½œä¸ºæ¶ˆæ¯
        message = " ".join(sys.argv[1:])
        send_simple_message_custom(message)
    else:
        # å‘é€é»˜è®¤æµ‹è¯•æ¶ˆæ¯
        send_simple_message()